<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CKD Diet Tracker — Daily Diary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- App CSS (optional) -->
  <link href="{{ url_for('static', filename='app.css') }}" rel="stylesheet">

  <style>
    body { background:#f7fbff; }
    .table-sm td, .table-sm th { padding: .46rem .6rem; }
    .sticky-header th { position: sticky; top: 0; background: #fff; z-index: 2; }
    .num { text-align: right; }
    .w-7rem { width: 7rem; }
    .hint { font-size:.9rem; color:#667; }
    .shadow-soft { box-shadow: 0 .25rem .75rem rgba(0,0,0,.08); }
  </style>
</head>
<body class="p-3">

  <nav class="mb-3 p-2 rounded bg-dark text-white d-flex align-items-center shadow-soft">
    <div class="fs-5 fw-semibold">Daily Diary</div>
    <div class="ms-auto small">Experimental Grid × Servings → Log Today</div>
  </nav>

  <div class="container-fluid">

    {# ------- Safe defaults so the page renders even if vars are missing ------- #}
    {% set grid = grid if grid is defined else [] %}
    {% set servings_map = servings_map if servings_map is defined else {} %}
    {% set nf_default = [
      'Calories','Protein','Carbs','Fat',
      'Sat Fat','Mono Fat','Poly Fat','Sugar',
      'Sodium','Potassium','Calcium','Magnesium','Iron','Cholesterol'
    ] %}
    {% set nutrient_fields = nutrient_fields if nutrient_fields is defined and nutrient_fields else nf_default %}
    {% set preview = preview if preview is defined else None %}

    <!-- A) ENTRY FORM: list Experimental Grid with "Servings Today" input -->
    <div class="card mb-4 shadow-soft">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="card-title mb-0">Enter Servings for Today</h5>
          <div class="hint">Enter servings for any foods you ate; we’ll multiply by per-serving nutrients.</div>
        </div>
        <hr class="mt-2">

        {% if not grid %}
          <div class="alert alert-warning mb-0">
            No Experimental Grid found. Populate it on the Foods Grid page and/or ensure it’s stored in the session.
          </div>
        {% else %}
          <form method="post" action="{{ url_for('daily') }}">
            <div class="table-responsive" style="max-height: 55vh;">
              <table class="table table-sm table-hover align-middle">
                <thead class="sticky-header">
                  <tr>
                    <th>Food</th>
                    <th class="text-center">Size</th>
                    <th class="text-center">Units</th>
                    <th class="text-center">Weight</th>
                    <th class="text-center">Servings Today</th>
                    {% for f in nutrient_fields %}
                      <th class="text-center">{{ f }}</th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                  {% for row in grid %}
                    {% set rid = (row.id if row.id is defined else row.get('id')) | string %}
                    <tr>
                      <td>{{ row.Food if row.Food is defined else row.get('Food','') }}</td>
                      <td class="text-center">{{ row.Size if row.Size is defined else row.get('Size','') }}</td>
                      <td class="text-center">{{ row.Units if row.Units is defined else row.get('Units','') }}</td>
                      <td class="text-center">{{ row.Weight if row.Weight is defined else row.get('Weight','') }}</td>
                      <td class="text-center">
                        <input
                          type="number"
                          step="0.01"
                          min="0"
                          class="form-control form-control-sm text-end w-7rem d-inline-block"
                          name="servings[{{ rid }}]"
                          value="{{ servings_map.get(rid, 0) }}">
                      </td>
                      {% for f in nutrient_fields %}
                        <td class="num">
                          {{ (row[f] if f in row else row.get(f, 0)) }}
                        </td>
                      {% endfor %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="mt-3 d-flex gap-2">
              <button type="submit" class="btn btn-primary">Update Log Today</button>
              <a href="{{ url_for('daily') }}" class="btn btn-outline-secondary">Clear Preview</a>
            </div>
          </form>
        {% endif %}
      </div>
    </div>

    <!-- B) PREVIEW: multiplied nutrients (Experimental Grid × Servings) -->
    <div class="card shadow-soft">
      <div class="card-body">
        <div class="d-flex align-items-center mb-2">
          <h5 class="card-title mb-0">Log Today</h5>
          {% if preview and preview.date %}
            <div class="ms-2 small text-muted">for {{ preview.date }}</div>
          {% endif %}
        </div>
        <hr class="mt-2">

        {% if preview and preview.rows %}
          <div class="table-responsive" style="max-height: 55vh;">
            <table class="table table-sm table-striped align-middle">
              <thead class="sticky-header">
                <tr>
                  <th>Food</th>
                  <th class="text-center">Size</th>
                  <th class="text-center">Units</th>
                  <th class="text-center">Weight</th>
                  <th class="text-center">Servings</th>
                  {% for f in nutrient_fields %}
                    <th class="text-center">{{ f }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for r in preview.rows %}
                  <tr>
                    <td>{{ r.Food }}</td>
                    <td class="text-center">{{ r.Size }}</td>
                    <td class="text-center">{{ r.Units }}</td>
                    <td class="text-center">{{ r.Weight }}</td>
                    <td class="text-center">{{ '%.2f'|format((r.Servings|float) if r.Servings is defined else (r.get('Servings',0)|float)) }}</td>
                    {% for f in nutrient_fields %}
                      <td class="num">{{ '%.2f'|format((r.get(f, 0)|float)) }}</td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr class="table-secondary">
                  <th colspan="5" class="text-end">Totals</th>
                  {% for f in nutrient_fields %}
                    <th class="num">
                      {{ '%.2f'|format((preview.totals.get(f, 0)|float)) }}
                    </th>
                  {% endfor %}
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="hint">
            These values = per-serving nutrients from Experimental Grid × the “Servings Today” you entered above.
          </div>
        {% else %}
          <div class="alert alert-info mb-0">
            Enter one or more Servings above and click <strong>Update Log Today</strong> to see today’s multiplied totals.
          </div>
        {% endif %}
      </div>
    </div>

  </div>

  <!-- Bootstrap JS (optional for dropdowns, etc.) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
