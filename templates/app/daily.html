{# templates/app/daily.html #}
{% extends "app_base.html" %}
{% block title %}Daily Diary â€” Nutrition Tracker{% endblock %}

{% block head_extra %}
<style>
  /* ---- Tunable knobs ---------------------------------------------------- */
  :root{
    /* Right panel (Today card) width */
    --diary-right: 320px;

    /* Table column widths (left side) */
    --col-ate:   180px; /* Ate Today cell (amount + unit select) */
    --col-na:    90px; /* Na/serv (mg) */
    --col-napct: 90px; /* Sodium % of 1500 (bar) */
    --col-k:     90px; /* K/serv (mg) */
    --col-pro:   90px; /* Protein/serv (g) */
    --col-cal:   90px; /* Calories/serv */
  }

  @media (max-width: 1200px){
    :root{ --diary-right: 280px; }
  }

  .daily-layout {
    display: grid;
    grid-template-columns: 1fr var(--diary-right);
    gap: 16px;
  }

  .daily-layout > * { min-width: 0; }

  .table-wrap {
    border: 1px solid var(--tblr-border-color, #dadde1);
    border-radius: 8px;
    overflow: auto;
    background: var(--tblr-body-bg, #fff);
  }

  /* ---- Order bar (Option B) -------------------------------------------- */
  .order-bar{
    display:flex;
    align-items:center;
    gap:10px;
    padding: 10px 12px;
    border-bottom: 1px solid var(--tblr-border-color, #dadde1);
    background: var(--tblr-card-bg, #fff);
    position: sticky;
    top: 0;
    z-index: 3;
  }
  .order-bar .left{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap: wrap;
  }
  .order-bar select{
    font-size: 12px;
    padding: 3px 6px;
  }
  .order-bar .hint{
    font-size: 12px;
    color: #666;
  }

  .table-head {
    position: sticky;
    top: 44px; /* leave room for order bar */
    z-index: 2;
    background: var(--tblr-card-bg, #fff);
    border-bottom: 1px solid var(--tblr-border-color, #dadde1);
  }
  .table-body {
    max-height: 520px;
    overflow: auto;
  }

  #foods-table { table-layout: fixed; width: 100%; border-collapse: separate; border-spacing: 0; }
  #foods-table th, #foods-table td {
    padding: .5rem .6rem;
    vertical-align: middle;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  #foods-table th {
    font-size: 12px;
    white-space: normal;
  }

  #foods-body-table td {
    font-size: 12px;
  }

  #foods-table td:first-child, #foods-table th:first-child {
    white-space: normal;
  }

  /* Food cell + move controls */
  .food-cell{
    display:flex;
    gap:10px;
    align-items:flex-start;
    justify-content: space-between;
  }
  .food-name{
    min-width: 0;
  }
  .move-btns{
    display:flex;
    gap:4px;
    align-items:center;
    flex-shrink:0;
  }
  .move-btn{
    width: 22px;
    height: 18px;
    border-radius: 4px;
    border: 1px solid var(--tblr-border-color, #dadde1);
    background: #fff;
    color: #333;
    font-size: 11px;
    line-height: 1;
    padding: 0;
    cursor: pointer;
  }
  .move-btn:disabled{
    opacity: .4;
    cursor: default;
  }

  /* Pin button */
  .pin-btn{
    width: 22px;
    height: 18px;
    border-radius: 4px;
    border: 1px solid var(--tblr-border-color, #dadde1);
    background: #fff;
    color: #333;
    font-size: 12px;
    line-height: 1;
    padding: 0;
    cursor: pointer;
  }
  .pin-btn.pinned{
    background: #fff3bf;
    border-color: #ffd43b;
  }

  .ate-wrap {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: .35rem;
    align-items: center;
  }
  #foods-table input.amount {
    width: 100%;
    text-align: right;
  }
  .unit-label {
    font-size: 11px;
    color: #666;
    white-space: nowrap;
  }

  .sodbar {
    position: relative;
    height: 18px;
    border-radius: 4px;
    background: #f1f3f5;
    overflow: hidden;
  }
  .sodbar-fill {
    position: absolute;
    top: 0; left: 0; bottom: 0;
    width: 0%;
    background: linear-gradient(90deg, #4dabf7 0%, #74c0fc 60%, #ff6b6b 90%);
    transition: width 120ms ease-out;
  }

  .totals-card {
    border: 1px solid var(--tblr-border-color, #dadde1);
    border-radius: 8px;
    background: var(--tblr-body-bg, #fff);
  }
  .totals-card .card-header {
    padding: .75rem 1rem;
    border-bottom: 1px solid var(--tblr-border-color, #dadde1);
  }
  .totals-card .card-body { padding: 12px; }

  .meter { margin-bottom: 16px; }
  .meter-label {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    font-size: 14px;
    margin-bottom: 6px;
  }

  .meter-track {
    position: relative;
    height: 18px;
    border-radius: 5px;
    background: #f8f9fa;
    overflow: hidden;
  }

  .meter-fill-below,
  .meter-fill-in,
  .meter-fill-over {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 0%;
    transition: left 140ms ease-out, width 140ms ease-out, background-color 140ms ease-out;
  }

  .meter-fill-below { left: 0; background: #d0ebff; }
  .meter-fill-in    { background: #51cf66; }
  .meter-fill-over  { background: #ff6b6b; }

  .meter-marker {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #5c7cfa;
    opacity: 0.9;
    transform: translateX(-1px);
    pointer-events: none;
  }
  .meter-marker-high {
    background: #343a40;
  }

  .meter-inputs {
    display: flex;
    flex-wrap: wrap;
    gap: 6px 10px;
    align-items: center;
    margin-top: 4px;
    font-size: 12px;
  }
  .meter-inputs label {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin: 0;
  }
  .meter-inputs input[type="number"] {
    width: 72px;
    padding: 2px 4px;
    font-size: 12px;
  }

  .meter-goaltext {
    margin-top: 2px;
    font-size: 11px;
  }

  .date-controls { display:flex; gap:.5rem; align-items:center; }
</style>
{% endblock %}

{% block content %}
<div class="page-wrapper">
  <div class="container-xl">
    <div class="page-header d-print-none">
      <div class="row align-items-center">
        <div class="col">
          <h2 class="page-title">Daily Diary</h2>
          <div class="text-muted mt-1">Log what you ate â€” fast.</div>

          <div class="mt-3 d-flex flex-wrap align-items-center gap-3">
            <div class="d-flex flex-wrap align-items-baseline gap-2">
              <span class="fw-semibold">Date:</span>
              <span class="h4 mb-0" id="diary-date-display"></span>
              <span class="text-muted ms-2">You are entering data for this date.</span>
            </div>

            <button type="button" class="btn btn-success" id="btn-save-history">
              Save to History
            </button>
            <button type="button" class="btn btn-outline-danger ms-auto" id="btn-clear-diary">
              Clear Daily Diary
            </button>
          </div>

          <input type="hidden" id="day-picker" value="{{ today }}">
        </div>
      </div>
    </div>

    <div class="daily-layout">
      <!-- LEFT: Foods table -->
      <div class="table-wrap">

        <!-- Option B order controls -->
        <div class="order-bar">
          <div class="left">
            <span class="fw-semibold">Order:</span>
            <select id="order-mode" class="form-select form-select-sm" style="width:auto;">
              <option value="custom">Custom (use â–²â–¼)</option>
              <option value="az">A â†’ Z</option>
              <option value="recent">Recent (from what you entered)</option>
            </select>

            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-reset-order">
              Reset custom order
            </button>

            <label class="ms-2 hint">
              <input type="checkbox" id="pinned-only" style="transform: translateY(1px);">
              Pinned only
            </label>

            <span class="hint">Pins always float to the top.</span>
          </div>
        </div>

        <div class="table-head">
          <table class="table card-table mb-0" id="foods-table">
            <colgroup>
              <col>
              <col style="width: var(--col-ate)">
              <col style="width: var(--col-na)">
              <col style="width: var(--col-napct)">
              <col style="width: var(--col-k)">
              <col style="width: var(--col-pro)">
              <col style="width: var(--col-cal)">
            </colgroup>
            <thead>
              <tr>
                <th>Food</th>
                <th>Ate Today</th>
                <th>NA(mg)</th>
                <th>Sodium % of 1500</th>
                <th>K(mg)</th>
                <th>Protein/serv (g)</th>
                <th>Calories/serv</th>
              </tr>
            </thead>
          </table>
        </div>

        <div class="table-body">
          <table class="table card-table mb-0" id="foods-body-table">
            <colgroup>
              <col>
              <col style="width: var(--col-ate)">
              <col style="width: var(--col-na)">
              <col style="width: var(--col-napct)">
              <col style="width: var(--col-k)">
              <col style="width: var(--col-pro)">
              <col style="width: var(--col-cal)">
            </colgroup>
            <tbody id="foods-body"></tbody>
          </table>
        </div>
      </div>

      <!-- RIGHT: Today -->
      <div class="totals-card">
        <div class="card-header">
          <h3 class="card-title mb-0">Today</h3>
          <div class="text-muted small">
            Enter your low / high range. Bars show:
            blue = below range, green = in range, red = above.
            Markers slide as you change the numbers.
          </div>
        </div>

        <div class="card-body" id="totals-panel"></div>

        <div class="card-body pt-0" id="all-totals-wrap">
          <hr class="my-2">
          <div class="fw-semibold mb-2">All nutrients (live totals)</div>
          <table class="table table-sm mb-0">
            <tbody id="all-totals-body"></tbody>
          </table>
        </div>

        <div class="card-footer d-grid gap-2">
          <a class="btn btn-outline" href="{{ url_for('reports_day') }}">View day report</a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

<script>
  // ================= Constants & Setup =================
  const GOALS = { na: 1500, k: 3400, pro: 70, cal: 1500 };
  const SCALE = 1.25;
  const $ = (s, r=document) => r.querySelector(s);
  const SETTINGS_KEY = 'diaryMeasurementSettings';

  // Ordering + pins (Option B + pins)
  const ORDER_MODE_KEY = "diary-order-mode-v1";       // 'custom' | 'az' | 'recent'
  const CUSTOM_ORDER_KEY = "diary-custom-order-v1";   // array of food names
  const RECENT_FOODS_KEY = "diary-recent-foods-v1";   // array of food names
  const PINNED_FOODS_KEY = "diary-food-pins-v1";      // array of food names
  const SHOW_PINNED_ONLY_KEY = "diary-food-pins-only-v1"; // "1" or "0"
  let ORDER_MODE = "custom";
  let SHOW_PINNED_ONLY = false;

  let FOODS = [];
  let DATE_ISO = null;
  let MEASUREMENT_SETTINGS = {};

  let GOAL_RANGES = {
    na:  { low: 0, high: GOALS.na },
    k:   { low: 0, high: GOALS.k },
    pro: { low: 0, high: GOALS.pro },
    cal: { low: 0, high: GOALS.cal },
  };

  function loadMeasurementSettings() {
    try {
        MEASUREMENT_SETTINGS = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');
    } catch (e) {
        console.warn("Failed to load measurement settings", e);
        MEASUREMENT_SETTINGS = {};
    }
  }

  // -------- Pins helpers --------
  function getPinnedFoods(){
    try {
      const raw = localStorage.getItem(PINNED_FOODS_KEY);
      const arr = JSON.parse(raw || "[]");
      return Array.isArray(arr) ? arr.map(x => String(x)) : [];
    } catch(e){
      return [];
    }
  }

  function isPinned(foodName){
    const name = String(foodName||"").toLowerCase();
    return getPinnedFoods().some(x => x.toLowerCase() === name);
  }

  function togglePinned(foodName){
    const name = String(foodName||"").trim();
    if (!name) return;

    const list = getPinnedFoods();
    const lower = name.toLowerCase();
    const exists = list.some(x => x.toLowerCase() === lower);

    const next = exists
      ? list.filter(x => x.toLowerCase() !== lower)
      : [name, ...list];

    try { localStorage.setItem(PINNED_FOODS_KEY, JSON.stringify(next)); } catch(e){}
  }

  function loadPinnedOnly(){
    SHOW_PINNED_ONLY = (localStorage.getItem(SHOW_PINNED_ONLY_KEY) === "1");
    const cb = document.getElementById("pinned-only");
    if (cb) cb.checked = SHOW_PINNED_ONLY;
  }

  function setPinnedOnly(v){
    SHOW_PINNED_ONLY = !!v;
    try { localStorage.setItem(SHOW_PINNED_ONLY_KEY, SHOW_PINNED_ONLY ? "1":"0"); } catch(e){}
  }

  // -------- Ordering helpers --------
  function loadOrderMode(){
    const v = localStorage.getItem(ORDER_MODE_KEY);
    ORDER_MODE = (v === "az" || v === "recent" || v === "custom") ? v : "custom";
    const sel = document.getElementById("order-mode");
    if (sel) sel.value = ORDER_MODE;
  }

  function setOrderMode(v){
    ORDER_MODE = (v === "az" || v === "recent" || v === "custom") ? v : "custom";
    try { localStorage.setItem(ORDER_MODE_KEY, ORDER_MODE); } catch(e){}
  }

  function getCustomOrder(){
    try {
      const raw = localStorage.getItem(CUSTOM_ORDER_KEY);
      const arr = JSON.parse(raw || "[]");
      return Array.isArray(arr) ? arr.map(String) : [];
    } catch(e){
      return [];
    }
  }

  function setCustomOrder(arr){
    try { localStorage.setItem(CUSTOM_ORDER_KEY, JSON.stringify(arr || [])); } catch(e){}
  }

  function ensureCustomOrderSeed(){
    const existing = getCustomOrder();
    if (existing.length) return;
    const seed = (FOODS || []).map(f => f.food).filter(Boolean);
    setCustomOrder(seed);
  }

  function getRecentFoods(){
    try {
      const raw = localStorage.getItem(RECENT_FOODS_KEY);
      const arr = JSON.parse(raw || "[]");
      return Array.isArray(arr) ? arr.map(String) : [];
    } catch(e){
      return [];
    }
  }

  function touchRecentFood(name){
    const nm = String(name||"").trim();
    if (!nm) return;
    const list = getRecentFoods();
    const lower = nm.toLowerCase();
    const next = [nm, ...list.filter(x => String(x).toLowerCase() !== lower)].slice(0, 200);
    try { localStorage.setItem(RECENT_FOODS_KEY, JSON.stringify(next)); } catch(e){}
  }

  function snapshotAmounts(){
    const snap = {};
    document.querySelectorAll("#foods-body tr").forEach(tr => {
      const food = (tr.dataset.food || "").toLowerCase();
      const amt = tr.querySelector("input.amount")?.value;
      if (food) snap[food] = amt;
    });
    return snap;
  }

  function restoreAmounts(snap){
    if (!snap) return;
    document.querySelectorAll("#foods-body tr").forEach(tr => {
      const food = (tr.dataset.food || "").toLowerCase();
      if (!food) return;
      const amt = snap[food];
      if (amt != null) {
        const input = tr.querySelector("input.amount");
        if (input) input.value = amt;
        updateRowNutrientCells(tr);
        updateRowSodiumBar(tr);
      }
    });
  }

  function getDisplayFoods(){
    const base = Array.isArray(FOODS) ? FOODS : [];
    if (!base.length) return [];

    const pinnedList = getPinnedFoods();
    const pinnedSet = new Set(pinnedList.map(x => x.toLowerCase()));

    const filtered = SHOW_PINNED_ONLY
      ? base.filter(f => pinnedSet.has(String(f.food||"").toLowerCase()))
      : base;

    let ordered = [];

    if (ORDER_MODE === "az"){
      ordered = [...filtered].sort((a,b) =>
        String(a.food||"").localeCompare(String(b.food||""), undefined, { sensitivity: "base" })
      );
    } else if (ORDER_MODE === "recent"){
      const recent = getRecentFoods();
      const idx = new Map();
      recent.forEach((nm,i) => idx.set(nm.toLowerCase(), i));

      ordered = [...filtered].sort((a,b) => {
        const ai = idx.has(String(a.food||"").toLowerCase()) ? idx.get(String(a.food||"").toLowerCase()) : 1e9;
        const bi = idx.has(String(b.food||"").toLowerCase()) ? idx.get(String(b.food||"").toLowerCase()) : 1e9;
        if (ai !== bi) return ai - bi;
        return String(a.food||"").localeCompare(String(b.food||""), undefined, { sensitivity:"base" });
      });
    } else {
      // custom
      ensureCustomOrderSeed();
      const custom = getCustomOrder();
      const idx = new Map();
      custom.forEach((nm,i) => idx.set(nm.toLowerCase(), i));

      ordered = [...filtered].sort((a,b) => {
        const ai = idx.has(String(a.food||"").toLowerCase()) ? idx.get(String(a.food||"").toLowerCase()) : 1e9;
        const bi = idx.has(String(b.food||"").toLowerCase()) ? idx.get(String(b.food||"").toLowerCase()) : 1e9;
        if (ai !== bi) return ai - bi;
        return String(a.food||"").localeCompare(String(b.food||""), undefined, { sensitivity:"base" });
      });
    }

    // Pinned foods float to the top (stable)
    ordered = [...ordered].sort((a,b) => {
      const ap = pinnedSet.has(String(a.food||"").toLowerCase()) ? 0 : 1;
      const bp = pinnedSet.has(String(b.food||"").toLowerCase()) ? 0 : 1;
      if (ap !== bp) return ap - bp;
      return 0;
    });

    return ordered;
  }

  function loadGoalRanges(){
    try {
      const raw = localStorage.getItem("diary-goal-ranges-v2");
      if (!raw) return;
      const data = JSON.parse(raw);
      if (!data || typeof data !== "object") return;

      ["na","k","pro","cal"].forEach(key => {
        if (data[key]) {
          const d = data[key];
          const base = GOAL_RANGES[key] || { low: 0, high: GOALS[key] || 0 };
          GOAL_RANGES[key] = {
            low:  typeof d.low  === "number" ? d.low  : base.low,
            high: typeof d.high === "number" ? d.high : base.high,
          };
        }
      });
    } catch (e) {
      console.warn("Failed to load goal ranges", e);
    }
  }

  function saveGoalRanges(){
    try {
      localStorage.setItem("diary-goal-ranges-v2", JSON.stringify(GOAL_RANGES));
    } catch (e) {
      console.warn("Failed to save goal ranges", e);
    }
  }

  function onGoalInputChange(e){
    const input = e.target;
    const key = input.dataset.key;
    const role = input.dataset.role;
    if (!key || !role) return;

    let val = Number(input.value);
    if (!Number.isFinite(val) || val < 0) val = 0;

    if (!GOAL_RANGES[key]) {
      GOAL_RANGES[key] = { low: 0, high: GOALS[key] || 0 };
    }

    if (role === "low") {
      GOAL_RANGES[key].low = val;
      if (GOAL_RANGES[key].low > GOAL_RANGES[key].high) {
        GOAL_RANGES[key].high = GOAL_RANGES[key].low;
        const hiInput = document.getElementById(`m-${key}-high`);
        if (hiInput) hiInput.value = GOAL_RANGES[key].high;
      }
    } else {
      GOAL_RANGES[key].high = val;
      if (GOAL_RANGES[key].high < GOAL_RANGES[key].low) {
        GOAL_RANGES[key].low = GOAL_RANGES[key].high;
        const loInput = document.getElementById(`m-${key}-low`);
        if (loInput) loInput.value = GOAL_RANGES[key].low;
      }
    }

    saveGoalRanges();
    updateTotals();
  }

  async function loadFoodsFromUniver(){
    const resp = await fetch('/univer/api/foods-table', { credentials: 'same-origin' });
    if (!resp.ok) throw new Error('Failed to load Univer foods-table: HTTP ' + resp.status);
    const js = await resp.json();
    if (!js.ok) throw new Error('Univer backend returned not-ok: ' + (js.error || 'unknown'));

    const rows = Array.isArray(js.rows) ? js.rows : [];
    if (!rows.length) {
      FOODS = [];
      return;
    }

    const header = (rows[0] || []).map(v => String(v ?? '').trim());
    const dataRows = rows.slice(1);

    function idxOf(name) {
      const target = name.toLowerCase();
      return header.findIndex(h => h.toLowerCase() === target);
    }

    const idxFood        = idxOf("Food");
    const idxServingSize = idxOf("Serving Size");
    const idxServingUnit = idxOf("Serving Unit");
    const idxLabelUnits  = idxOf("Label Units");
    const idxUnitType    = idxOf("Unit Type");

    const idxCalories    = idxOf("Calories");
    const idxProtein     = idxOf("Protein (g)");
    const idxCarbs       = idxOf("Carbs (g)");
    const idxFat         = idxOf("Fat (g)");
    const idxSat         = idxOf("Sat Fat (g)");
    const idxMono        = idxOf("Mono Fat (g)");
    const idxPoly        = idxOf("Poly Fat (g)");
    const idxSugar       = idxOf("Sugar (g)");
    const idxSodium      = idxOf("Sodium (mg)");
    const idxPotassium   = idxOf("Potassium (mg)");
    const idxCalcium     = idxOf("Calcium (mg)");
    const idxMagnesium   = idxOf("Magnesium (mg)");
    const idxIron        = idxOf("Iron (mg)");
    const idxChol        = idxOf("Cholesterol (mg)");

    if (idxFood < 0 || idxSodium < 0 || idxPotassium < 0 || idxProtein < 0 || idxCalories < 0) {
      throw new Error("Required columns not found in Univer header row");
    }

    const numAt = (row, idx) =>
      (idx >= 0 && row[idx] != null && row[idx] !== "") ? (Number(row[idx]) || 0) : 0;

    const out = [];
    for (const row of dataRows) {
      if (!row) continue;
      const name = row[idxFood];
      if (!name || !String(name).trim()) continue;

      out.push({
        food:        String(name).trim(),
        servingSize: numAt(row, idxServingSize),
        servingUnit: idxServingUnit >= 0 ? (row[idxServingUnit] || "").toString() : "",
        unitType:    idxUnitType    >= 0 ? (row[idxUnitType]    || "").toString() : "",
        labelUnits:  numAt(row, idxLabelUnits) || 1,

        cal:   numAt(row, idxCalories),
        pro:   numAt(row, idxProtein),
        carbs: numAt(row, idxCarbs),
        fat:   numAt(row, idxFat),
        sat:   numAt(row, idxSat),
        mono:  numAt(row, idxMono),
        poly:  numAt(row, idxPoly),
        sugar: numAt(row, idxSugar),

        na:    numAt(row, idxSodium),
        k:     numAt(row, idxPotassium),
        ca:    numAt(row, idxCalcium),
        mg:    numAt(row, idxMagnesium),
        iron:  numAt(row, idxIron),
        chol:  numAt(row, idxChol),
      });
    }

    FOODS = out;
  }

  function sodiumBarCell(percent){
    const pct = Math.max(0, Math.min(percent, 100 * SCALE));
    return `
      <div class="sodbar" aria-label="Sodium percent of 1500">
        <div class="sodbar-fill" style="width:${pct}%;"></div>
      </div>
    `;
  }

  function renderFoods(){
    const tbody = $("#foods-body");
    tbody.innerHTML = "";

    const displayFoods = getDisplayFoods();
    const pinnedList = getPinnedFoods();
    const pinnedSet = new Set(pinnedList.map(x => x.toLowerCase()));

    for (let displayIndex = 0; displayIndex < displayFoods.length; displayIndex++){
      const f = displayFoods[displayIndex];
      const tr = document.createElement("tr");

      const measurementUnit = MEASUREMENT_SETTINGS[f.food] || 'grams';
      const labelText = measurementUnit === 'grams' ? 'Enter gram weight' : `Enter number of ${measurementUnit}`;
      const canMove = (ORDER_MODE === "custom");

      const pinned = pinnedSet.has(String(f.food||"").toLowerCase());

      tr.innerHTML = `
        <td>
          <div class="food-cell">
            <div class="food-name" title="${f.food}">${f.food}</div>
            <div class="move-btns">
              <button type="button"
                      class="pin-btn ${pinned ? "pinned" : ""}"
                      data-action="pin"
                      title="Pin/unpin">
                ${pinned ? "ðŸ“Œ" : "â˜†"}
              </button>

              <button type="button"
                      class="move-btn"
                      data-action="up"
                      title="Move up"
                      ${(!canMove) ? "disabled" : ""}>
                â–²
              </button>
              <button type="button"
                      class="move-btn"
                      data-action="down"
                      title="Move down"
                      ${(!canMove) ? "disabled" : ""}>
                â–¼
              </button>
            </div>
          </div>
        </td>

        <td>
          <div class="ate-wrap">
            <span class="unit-label">${labelText}</span>
            <input class="form-control form-control-sm amount" type="number" step="0.25" min="0" value="0">
          </div>
        </td>
        <td class="text-end na">0</td>
        <td class="sodbar-cell">${sodiumBarCell(0)}</td>
        <td class="text-end k">0</td>
        <td class="text-end pro">0</td>
        <td class="text-end cal">0</td>
      `;

      tr.dataset.food  = f.food ?? "";
      tr.dataset.na    = f.na    ?? 0;
      tr.dataset.k     = f.k     ?? 0;
      tr.dataset.pro   = f.pro   ?? 0;
      tr.dataset.cal   = f.cal   ?? 0;
      tr.dataset.chol  = f.chol  ?? 0;
      tr.dataset.carbs = f.carbs ?? 0;
      tr.dataset.fat   = f.fat   ?? 0;
      tr.dataset.sat   = f.sat   ?? 0;
      tr.dataset.mono  = f.mono  ?? 0;
      tr.dataset.poly  = f.poly  ?? 0;
      tr.dataset.sugar = f.sugar ?? 0;
      tr.dataset.ca    = f.ca    ?? 0;
      tr.dataset.mg    = f.mg    ?? 0;
      tr.dataset.iron  = f.iron  ?? 0;
      tr.dataset.labelUnits = f.labelUnits ?? 1;
      tr.dataset.servingSize = f.servingSize ?? 100;
      tr.dataset.unit = measurementUnit;

      const input = tr.querySelector("input.amount");
      input.addEventListener("input", onAmountChange);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") e.currentTarget.blur();
      });

      tbody.appendChild(tr);
    }

    // Single delegated handler for pin + move
    tbody.onclick = (ev) => {
      const btn = ev.target.closest("button.move-btn, button.pin-btn");
      if (!btn) return;

      const tr = btn.closest("tr");
      if (!tr) return;

      const action = btn.dataset.action;
      const foodName = tr.dataset.food || "";
      if (!foodName) return;

      const snap = snapshotAmounts();

      // Pin/unpin
      if (action === "pin"){
        togglePinned(foodName);
        renderFoods();
        restoreAmounts(snap);
        updateTotals();
        saveDraft();
        return;
      }

      // Moves only in custom mode
      if (ORDER_MODE !== "custom") return;

      ensureCustomOrderSeed();
      const custom = getCustomOrder();

      // Moves should operate within pinned group or unpinned group (since pins float)
      const pinned = isPinned(foodName);
      const displayFoods = getDisplayFoods();
      const group = displayFoods.filter(f => isPinned(f.food) === pinned).map(f => f.food);

      const idxInGroup = group.findIndex(nm => String(nm).toLowerCase() === String(foodName).toLowerCase());
      if (idxInGroup < 0) return;

      let swapWith = -1;
      if (action === "up")   swapWith = idxInGroup - 1;
      if (action === "down") swapWith = idxInGroup + 1;
      if (swapWith < 0 || swapWith >= group.length) return;

      const aName = group[idxInGroup];
      const bName = group[swapWith];

      const aLower = String(aName).toLowerCase();
      const bLower = String(bName).toLowerCase();

      // Ensure both exist in custom; if not, seed again.
      if (!custom.length) ensureCustomOrderSeed();
      const next = [...getCustomOrder()];

      const ai = next.findIndex(x => String(x).toLowerCase() === aLower);
      const bi = next.findIndex(x => String(x).toLowerCase() === bLower);
      if (ai < 0 || bi < 0) return;

      // Swap positions in custom order
      const tmp = next[ai];
      next[ai] = next[bi];
      next[bi] = tmp;

      setCustomOrder(next);

      renderFoods();
      restoreAmounts(snap);
      updateTotals();
      saveDraft();
    };
  }

  function effectiveServings(tr){
    const amt = Number(tr.querySelector("input.amount").value) || 0;
    const unit = tr.dataset.unit || 'grams';
    const servingSize = Number(tr.dataset.servingSize) || 100;

    if (unit === 'grams') {
        return amt / servingSize;
    } else {
        return amt;
    }
  }

  function ensureTotalsPanel(){
    const host = $("#totals-panel");
    if (!host) return;
    host.innerHTML = "";
    makeMeter(host, "Sodium", "na", "mg", GOALS.na);
    makeMeter(host, "Potassium", "k", "mg", GOALS.k);
    makeMeter(host, "Protein", "pro", "g", GOALS.pro);
    makeMeter(host, "Calories", "cal", "", GOALS.cal);
  }

  function makeMeter(host, label, key, unit, goal){
    const range = GOAL_RANGES[key] || { low: 0, high: goal };

    const wrap = document.createElement("div");
    wrap.className = "meter";
    wrap.innerHTML = `
      <div class="meter-label">
        <span>${label}</span>
        <span id="m-${key}-val">0 ${unit}</span>
      </div>
      <div class="meter-track" id="m-${key}-track">
        <div class="meter-fill-below" id="m-${key}-below"></div>
        <div class="meter-fill-in" id="m-${key}-in"></div>
        <div class="meter-fill-over" id="m-${key}-over"></div>
        <div class="meter-marker" id="m-${key}-lowmark" style="left:0%;"></div>
        <div class="meter-marker meter-marker-high" id="m-${key}-highmark" style="left:0%;"></div>
      </div>
      <div class="meter-inputs">
        <label>
          Low
          <input type="number"
                 id="m-${key}-low"
                 data-key="${key}"
                 data-role="low"
                 min="0"
                 step="10"
          >
          ${unit}
        </label>
        <label>
          High
          <input type="number"
                 id="m-${key}-high"
                 data-key="${key}"
                 data-role="high"
                 min="0"
                 step="10"
          >
          ${unit}
        </label>
      </div>
      <div class="text-muted meter-goaltext" id="m-${key}-goaltext"></div>
    `;
    host.appendChild(wrap);

    const lowInput  = wrap.querySelector(`#m-${key}-low`);
    const highInput = wrap.querySelector(`#m-${key}-high`);
    if (lowInput)  lowInput.value  = range.low ?? 0;
    if (highInput) highInput.value = range.high ?? goal;

    if (lowInput)  lowInput.addEventListener("change", onGoalInputChange);
    if (highInput) highInput.addEventListener("change", onGoalInputChange);

    const goalText = wrap.querySelector(`#m-${key}-goaltext`);
    if (goalText) {
      goalText.textContent = `Range: ${range.low.toLocaleString()}â€“${range.high.toLocaleString()} ${unit}`.trim();
    }
  }

  function onAmountChange(e){
    const tr = e.target.closest("tr");
    if (!tr) return;

    // Touch recent list when user enters something
    const amt = Number(tr.querySelector("input.amount").value) || 0;
    if (amt > 0) touchRecentFood(tr.dataset.food);

    updateRowSodiumBar(tr);
    updateRowNutrientCells(tr);
    updateTotals();
    saveDraft();
  }

  function updateRowSodiumBar(tr){
    const servings = effectiveServings(tr);
    const naPer = Number(tr.dataset.na) || 0;
    const naTotal = servings * naPer;
    const pct = (naTotal / (GOALS.na * SCALE)) * 100;
    const fill = tr.querySelector(".sodbar-fill");
    if (fill) fill.style.width = `${Math.max(0, Math.min(pct, 100))}%`;
  }

  function updateRowNutrientCells(tr){
    const servings = effectiveServings(tr);

    const naVal   = servings * (Number(tr.dataset.na)  || 0);
    const kVal    = servings * (Number(tr.dataset.k)   || 0);
    const proVal  = servings * (Number(tr.dataset.pro) || 0);
    const calVal  = servings * (Number(tr.dataset.cal) || 0);

    const naCell  = tr.querySelector("td.na");
    const kCell   = tr.querySelector("td.k");
    const proCell = tr.querySelector("td.pro");
    const calCell = tr.querySelector("td.cal");

    if (naCell)  naCell.textContent  = Math.round(naVal).toLocaleString();
    if (kCell)   kCell.textContent   = Math.round(kVal).toLocaleString();
    if (proCell) proCell.textContent = proVal.toFixed(1).replace(/\.0$/,"");
    if (calCell) calCell.textContent = Math.round(calVal).toLocaleString();
  }

  function sumFromTable(){
    const total = {
      na:0, k:0, pro:0, cal:0, chol:0,
      carbs:0, fat:0, sat:0, mono:0, poly:0, sugar:0,
      ca:0, mg:0, iron:0
    };
    document.querySelectorAll("#foods-body tr").forEach(tr => {
      const servings = effectiveServings(tr);

      total.na   += servings * (Number(tr.dataset.na)   || 0);
      total.k    += servings * (Number(tr.dataset.k)    || 0);
      total.pro  += servings * (Number(tr.dataset.pro)  || 0);
      total.cal  += servings * (Number(tr.dataset.cal)  || 0);
      total.chol += servings * (Number(tr.dataset.chol) || 0);

      total.carbs+= servings * (Number(tr.dataset.carbs)|| 0);
      total.fat  += servings * (Number(tr.dataset.fat)  || 0);
      total.sat  += servings * (Number(tr.dataset.sat)  || 0);
      total.mono += servings * (Number(tr.dataset.mono) || 0);
      total.poly += servings * (Number(tr.dataset.poly) || 0);
      total.sugar+= servings * (Number(tr.dataset.sugar)|| 0);
      total.ca   += servings * (Number(tr.dataset.ca)   || 0);
      total.mg   += servings * (Number(tr.dataset.mg)   || 0);
      total.iron += servings * (Number(tr.dataset.iron) || 0);
    });
    return total;
  }

  function paintMeter(key, value, goal, unit){
    const range = GOAL_RANGES[key] || { low: 0, high: goal };
    let low  = Math.max(0, Number(range.low)  || 0);
    let high = Math.max(low, Number(range.high) || goal);

    const cap = (high > 0 ? high * SCALE : (goal * SCALE) || 1);
    const pct = Math.max(0, Math.min((value / cap) * 100, 100));

    const belowEl = document.querySelector(`#m-${key}-below`);
    const inEl    = document.querySelector(`#m-${key}-in`);
    const overEl  = document.querySelector(`#m-${key}-over`);
    const lowMark = document.querySelector(`#m-${key}-lowmark`);
    const highMark= document.querySelector(`#m-${key}-highmark`);
    const valEl   = document.querySelector(`#m-${key}-val`);
    const goalText= document.querySelector(`#m-${key}-goaltext`);
    const lowInput= document.querySelector(`#m-${key}-low`);
    const highInput = document.querySelector(`#m-${key}-high`);
    if (!belowEl || !inEl || !overEl || !valEl) return;

    if (lowInput)  lowInput.value  = low;
    if (highInput) highInput.value = high;

    const lowPct  = Math.max(0, Math.min((low  / cap) * 100, 100));
    const highPct = Math.max(lowPct, Math.min((high / cap) * 100, 100));

    const belowWidth = Math.min(pct, lowPct);
    const inWidth    = Math.max(0, Math.min(pct, highPct) - lowPct);
    const overWidth  = Math.max(0, pct - highPct);

    belowEl.style.left  = "0%";
    belowEl.style.width = `${belowWidth}%`;

    inEl.style.left  = `${lowPct}%`;
    inEl.style.width = `${inWidth}%`;

    overEl.style.left  = `${highPct}%`;
    overEl.style.width = `${overWidth}%`;

    if (lowMark)  lowMark.style.left  = `${lowPct}%`;
    if (highMark) highMark.style.left = `${highPct}%`;

    const displayVal = unit
      ? `${Math.round(value).toLocaleString()} ${unit}`
      : `${Math.round(value).toLocaleString()}`;
    valEl.textContent = displayVal;

    if (goalText) {
      goalText.textContent = `Range: ${low.toLocaleString()}â€“${high.toLocaleString()} ${unit}`.trim();
    }
  }

  function renderAllTotals(){
    const t = totalsForHistory();
    const rows = [
      ["Sodium (mg)",      t.Sodium ?? 0],
      ["Potassium (mg)",   t.Potassium ?? 0],
      ["Protein (g)",      t.Protein ?? 0],
      ["Calories",         t.Calories ?? 0],
      ["Cholesterol (mg)", t.Cholesterol ?? 0],
      ["Carbs (g)",        t.Carbs ?? 0],
      ["Fat (g)",          t.Fat ?? 0],
      ["Sat Fat (g)",      t["Sat Fat"] ?? 0],
      ["Mono Fat (g)",     t["Mono Fat"] ?? 0],
      ["Poly Fat (g)",     t["Poly Fat"] ?? 0],
      ["Sugar (g)",        t.Sugar ?? 0],
      ["Calcium (mg)",     t.Calcium ?? 0],
      ["Magnesium (mg)",   t.Magnesium ?? 0],
      ["Iron (mg)",        t.Iron ?? 0]
    ];
    const tbody = document.getElementById("all-totals-body");
    if (!tbody) return;
    tbody.innerHTML = rows
      .map(([k,v]) => `<tr><td>${k}</td><td class="text-end">${Number(v||0).toLocaleString()}</td></tr>`)
      .join("");
  }

  function updateTotals(){
    const t = sumFromTable();
    paintMeter("na",  t.na,  GOALS.na,  "mg");
    paintMeter("k",   t.k,   GOALS.k,   "mg");
    paintMeter("pro", t.pro, GOALS.pro, "g");
    paintMeter("cal", t.cal, GOALS.cal, "");
    renderAllTotals();
  }

  function totalsForHistory(){
    const t = sumFromTable();
    return {
      Sodium:       Math.round(t.na),
      Potassium:    Math.round(t.k),
      Protein:      +t.pro.toFixed(1),
      Calories:     Math.round(t.cal),
      Cholesterol:  Math.round(t.chol),

      Carbs:        +t.carbs.toFixed(1),
      Fat:          +t.fat.toFixed(1),
      "Sat Fat":    +t.sat.toFixed(1),
      "Mono Fat":   +t.mono.toFixed(1),
      "Poly Fat":   +t.poly.toFixed(1),
      Sugar:        +t.sugar.toFixed(1),
      Calcium:      Math.round(t.ca),
      Magnesium:    Math.round(t.mg),
      Iron:         +t.iron.toFixed(1)
    };
  }

  function collectEntries(){
    const rows = [];
    document.querySelectorAll("#foods-body tr").forEach(tr => {
      const amt = Number(tr.querySelector("input.amount").value) || 0;
      if (amt <= 0) return;
      const servings = effectiveServings(tr);
      const num = (k) => servings * (Number(tr.dataset[k] || 0));
      rows.push({
        food:           tr.dataset.food || "",
        amount:         amt,
        unit:           tr.dataset.unit || 'grams',
        sodium_mg:      num("na"),
        potassium_mg:   num("k"),
        protein_g:      num("pro"),
        calories_kcal:  Math.round(num("cal")),
        cholesterol_mg: num("chol"),
        fat_g:          num("fat"),
        carbs_g:        num("carbs"),
        sugar_g:        num("sugar"),
        calcium_mg:     num("ca"),
        magnesium_mg:   num("mg"),
        iron_mg:        num("iron"),
      });
    });
    return rows;
  }

  function saveDraft() {
    const date = DATE_ISO;
    if (!date) return;

    const entries = [];
    document.querySelectorAll("#foods-body tr").forEach(tr => {
        const foodName = tr.dataset.food;
        const amount = tr.querySelector("input.amount").value;
        if (foodName && amount !== "" && Number(amount) !== 0) {
            entries.push({ food: foodName, amount: amount });
        }
    });

    try {
        if (entries.length > 0) {
            localStorage.setItem(`diary-draft-${date}`, JSON.stringify(entries));
        } else {
            localStorage.removeItem(`diary-draft-${date}`);
        }
    } catch (e) {
        console.warn("Failed to save draft to localStorage", e);
    }
  }

  function loadDraft() {
    const date = DATE_ISO;
    if (!date) return;

    try {
        const draft = localStorage.getItem(`diary-draft-${date}`);
        if (!draft) return;

        const entries = JSON.parse(draft);
        const entriesByFood = {};
        entries.forEach(e => { entriesByFood[e.food.toLowerCase()] = e; });

        document.querySelectorAll("#foods-body tr").forEach(tr => {
            const foodName = tr.dataset.food.toLowerCase();
            const entry = entriesByFood[foodName];
            if (entry) {
                const input = tr.querySelector("input.amount");
                if (input) {
                    input.value = entry.amount;
                    updateRowNutrientCells(tr);
                    updateRowSodiumBar(tr);
                }
            }
        });
    } catch (e) {
        console.warn("Failed to load draft from localStorage", e);
    }
  }

  async function loadFullDayForCurrentDate() {
    const date = DATE_ISO;
    if (!date) return;

    clearDiaryInputs();

    try {
      const url = window.__HISTORY_API__?.full_get;
      if (!url) {
        console.warn("No full_get URL wired.");
        return;
      }

      const resp = await fetch(`${url}?date=${encodeURIComponent(date)}`, {
        credentials: "same-origin",
      });

      if (resp.status === 404) {
        console.log("No saved full-day for", date);
      } else if (!resp.ok) {
        throw new Error("HTTP " + resp.status);
      } else {
        const js = await resp.json();
        if (!js.ok || !js.day) {
          throw new Error("Bad full-day JSON");
        }
        const entries = js.day.entries || [];
        applyEntriesToDiary(entries);
      }
    } catch (err) {
      console.error("loadFullDayForCurrentDate error", err);
    } finally {
        loadDraft();
        updateTotals();
    }
  }

  function clearDiaryInputs() {
    document.querySelectorAll("#foods-body tr").forEach(tr => {
      const amt = tr.querySelector("input.amount");
      if (amt) amt.value = "0";
      updateRowNutrientCells(tr);
      updateRowSodiumBar(tr);
    });
  }

  function applyEntriesToDiary(entries) {
    const byFood = {};
    (entries || []).forEach(e => {
      if (!e.food) return;
      byFood[String(e.food).toLowerCase()] = e;
    });

    document.querySelectorAll("#foods-body tr").forEach(tr => {
      const name = (tr.dataset.food || "").toLowerCase();
      const e = byFood[name];
      if (!e) return;

      const amt = tr.querySelector("input.amount");
      if (amt) amt.value = (e.amount != null ? e.amount : 0);

      updateRowNutrientCells(tr);
      updateRowSodiumBar(tr);
    });
  }

  function dateFromIso(iso) {
    const [y, m, d] = iso.split("-").map(Number);
    return new Date(y, m - 1, d);
  }

  function toIsoDate(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function updateDisplayedDate() {
    const span = document.getElementById("diary-date-display");
    if (span && DATE_ISO) {
      span.textContent = DATE_ISO;
    }
  }

  function initDate() {
    const picker = document.getElementById("day-picker");

    if (picker) {
      if (!picker.value) {
        const today = new Date();
        picker.value = toIsoDate(today);
      }
      DATE_ISO = picker.value;
      updateDisplayedDate();

      picker.addEventListener("change", () => {
        DATE_ISO = picker.value || DATE_ISO;
        updateDisplayedDate();
        loadFullDayForCurrentDate();
      });
    } else {
      const today = new Date();
      DATE_ISO = toIsoDate(today);
      updateDisplayedDate();
    }
  }

  window.__HISTORY_API__ = Object.assign(window.__HISTORY_API__ || {}, {
    save:      "{{ url_for('history.api_day_save') }}",
    get:       "{{ url_for('history.api_day_get') }}",
    full_get:  "{{ url_for('history.api_full_day_get') }}"
  });

  async function handleSaveToHistory(ev){
    ev?.preventDefault?.();
    const date = (document.querySelector("#day-picker")?.value || "").trim();
    if (!date) { alert("Pick a date first."); return; }

    try { updateTotals(); } catch(e) {}

    const payload = { date, totals: totalsForHistory(), entries: collectEntries() };
    console.log("Saving payload", payload);

    const btn = document.getElementById("btn-save-history");
    if (btn) { btn.disabled = true; btn.textContent = "Savingâ€¦"; }

    try{
      const res = await fetch(window.__HISTORY_API__.save, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        credentials: "same-origin",
        body: JSON.stringify(payload)
      });
      const js = await res.json().catch(()=> ({}));
      if (!res.ok || !js.ok) throw new Error(js.error || ("HTTP "+res.status));
      if (btn) {
        btn.classList.remove("btn-success");
        btn.classList.add("btn-secondary");
        btn.textContent = "Saved";
      }
      alert("Saved day " + date);
      localStorage.removeItem(`diary-draft-${date}`);
    }catch(e){
      console.error(e);
      alert("Save failed: " + e.message);
      if (btn) { btn.disabled = false; btn.textContent = "Save to History"; }
    }
  }

  function clearDiaryAndDraft() {
    if (!confirm("Are you sure you want to clear all amounts for this day? This cannot be undone.")) {
        return;
    }
    clearDiaryInputs();
    updateTotals();
    saveDraft(); // clears draft
  }

  function wireOrderControls(){
    const sel = document.getElementById("order-mode");
    const btnReset = document.getElementById("btn-reset-order");
    const pinnedOnly = document.getElementById("pinned-only");

    if (sel){
      sel.addEventListener("change", () => {
        const snap = snapshotAmounts();
        setOrderMode(sel.value);
        renderFoods();
        restoreAmounts(snap);
        updateTotals();
        saveDraft();
      });
    }

    if (btnReset){
      btnReset.addEventListener("click", () => {
        if (!confirm("Reset custom order back to the current default order?")) return;
        const snap = snapshotAmounts();
        const seed = (FOODS || []).map(f => f.food).filter(Boolean);
        setCustomOrder(seed);
        setOrderMode("custom");
        if (sel) sel.value = "custom";
        renderFoods();
        restoreAmounts(snap);
        updateTotals();
        saveDraft();
      });
    }

    if (pinnedOnly){
      pinnedOnly.addEventListener("change", () => {
        const snap = snapshotAmounts();
        setPinnedOnly(pinnedOnly.checked);
        renderFoods();
        restoreAmounts(snap);
        updateTotals();
        saveDraft();
      });
    }
  }

  function refreshDisplay() {
      loadMeasurementSettings();
      renderFoods();
      loadFullDayForCurrentDate();
  }

  (async function boot(){
    try{
      initDate();
      await loadFoodsFromUniver();

      loadOrderMode();
      loadPinnedOnly();
      wireOrderControls();

      loadGoalRanges();
      ensureTotalsPanel();

      // seed custom order on first run
      ensureCustomOrderSeed();

      refreshDisplay();
    }catch(err){
      console.error(err);

      loadOrderMode();
      loadPinnedOnly();
      wireOrderControls();

      renderFoods();
      loadGoalRanges();
      ensureTotalsPanel();
      updateTotals();
    }
    document.getElementById("btn-save-history")?.addEventListener("click", handleSaveToHistory);
    document.getElementById("btn-clear-diary")?.addEventListener("click", clearDiaryAndDraft);
  })();

  window.addEventListener('pageshow', function(event) {
      if (event.persisted) {
          refreshDisplay();
      }
  });
</script>
{% endblock %}
