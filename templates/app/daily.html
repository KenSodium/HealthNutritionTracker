{# templates/app/daily.html #}
{% extends "app_base.html" %}
{% block title %}Daily Diary — Nutrition Tracker{% endblock %}

{% block head_extra %}
<style>
  /* ---- Tunable knobs ---------------------------------------------------- */
  :root{
    /* Right panel (Today card) width */
    --diary-right: 320px;

    /* Table column widths (left side) */
    --col-ate:   120px; /* Ate Today cell (amount + unit select) */
    --col-na:    100px; /* Na/serv (mg) */
    --col-napct: 100px; /* Sodium % of 1500 (bar) */
    --col-k:     100px; /* K/serv (mg) */
    --col-pro:   100px; /* Protein/serv (g) */
    --col-cal:   100px; /* Calories/serv */
  }

  @media (max-width: 1200px){
    :root{ --diary-right: 280px; }
  }

  .daily-layout {
    display: grid;
    grid-template-columns: 1fr var(--diary-right);
    gap: 16px;
  }

  .daily-layout > * { min-width: 0; }

  .table-wrap {
    border: 1px solid var(--tblr-border-color, #dadde1);
    border-radius: 8px;
    overflow: auto;
    background: var(--tblr-body-bg, #fff);
  }
  .table-head {
    position: sticky;
    top: 0;
    z-index: 2;
    background: var(--tblr-card-bg, #fff);
    border-bottom: 1px solid var(--tblr-border-color, #dadde1);
  }
  .table-body {
    max-height: 520px;
    overflow: auto;
  }

  #foods-table { table-layout: fixed; width: 100%; border-collapse: separate; border-spacing: 0; }
  #foods-table th, #foods-table td {
    padding: .5rem .6rem;
    font-size: 15px;
    vertical-align: middle;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #foods-table th { white-space: normal; }

  #foods-table td:first-child, #foods-table th:first-child {
    white-space: normal;
  }

  .ate-wrap {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: .35rem;
    align-items: center;
  }
  #foods-table input.amount {
    width: 100%;
    text-align: right;
  }
  .unit-select {
    width: 100%;
    min-width: 0;
  }

  .sodbar {
    position: relative;
    height: 18px;
    border-radius: 4px;
    background: #f1f3f5;
    overflow: hidden;
  }
  .sodbar-fill {
    position: absolute;
    top: 0; left: 0; bottom: 0;
    width: 0%;
    background: linear-gradient(90deg, #4dabf7 0%, #74c0fc 60%, #ff6b6b 90%);
    transition: width 120ms ease-out;
  }

  .totals-card {
    border: 1px solid var(--tblr-border-color, #dadde1);
    border-radius: 8px;
    background: var(--tblr-body-bg, #fff);
  }
  .totals-card .card-header {
    padding: .75rem 1rem;
    border-bottom: 1px solid var(--tblr-border-color, #dadde1);
  }
  .totals-card .card-body { padding: 12px; }

  .meter { margin-bottom: 16px; }
  .meter-label {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    font-size: 14px;
    margin-bottom: 6px;
  }

  .meter-track {
    position: relative;
    height: 18px;
    border-radius: 5px;
    background: #f8f9fa;  /* neutral background */
    overflow: hidden;
  }

  /* Three segments: below range (blue), in-range (green), over-range (red) */
  .meter-fill-below,
  .meter-fill-in,
  .meter-fill-over {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 0%;
    transition: left 140ms ease-out, width 140ms ease-out, background-color 140ms ease-out;
  }

  .meter-fill-below { left: 0; background: #d0ebff; }    /* light blue */
  .meter-fill-in    { background: #51cf66; }              /* bright green */
  .meter-fill-over  { background: #ff6b6b; }              /* bright red */

  /* Vertical markers for low and high thresholds */
  .meter-marker {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #5c7cfa; /* navy-ish marker */
    opacity: 0.9;
    transform: translateX(-1px);
    pointer-events: none;
  }
  .meter-marker-high {
    background: #343a40;
  }

  .meter-inputs {
    display: flex;
    flex-wrap: wrap;
    gap: 6px 10px;
    align-items: center;
    margin-top: 4px;
    font-size: 12px;
  }
  .meter-inputs label {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin: 0;
  }
  .meter-inputs input[type="number"] {
    width: 72px;
    padding: 2px 4px;
    font-size: 12px;
  }

  .meter-goaltext {
    margin-top: 2px;
    font-size: 11px;
  }

  .date-controls { display:flex; gap:.5rem; align-items:center; }
</style>
{% endblock %}

{% block content %}
<div style="
  position: fixed;
  top: 4px;
  right: 10px;
  z-index: 9999;
  background: yellow;
  color: black;
  padding: 4px 8px;
  font-size: 12px;
  border: 1px solid #000;
">
  DAILY v4 — app/daily.html
</div>
<div class="page-wrapper">
  <div class="container-xl">
    <div class="page-header d-print-none">
      <div class="row align-items-center">
        <div class="col">
          <h2 class="page-title">Daily Diary</h2>
          <div class="text-muted mt-1">Log what you ate — fast.</div>
        </div>
        <div class="col-auto ms-auto d-print-none">
          <div class="date-controls">
            <button class="btn btn-outline" id="btn-prev" type="button">←</button>
            <input class="form-control" type="date" id="day-picker" style="width: 180px;" value="{{ today }}">
            <button class="btn btn-outline" id="btn-next" type="button">→</button>
            <a class="btn btn-primary" href="{{ url_for('app_daily') }}">Today</a>
          </div>
        </div>
      </div>
    </div>

    <div class="daily-layout">
      <!-- LEFT: Foods table -->
      <div class="table-wrap">
        <div class="table-head">
          <table class="table card-table mb-0" id="foods-table">
            <colgroup>
              <col>
              <col style="width: var(--col-ate)">
              <col style="width: var(--col-na)">
              <col style="width: var(--col-napct)">
              <col style="width: var(--col-k)">
              <col style="width: var(--col-pro)">
              <col style="width: var(--col-cal)">
            </colgroup>
            <thead>
              <tr>
                <th>Food</th>
                <th>Ate Today</th>
                <th>NA(mg)</th>
                <th>Sodium % of 1500</th>
                <th>K(mg)</th>
                <th>Protein/serv (g)</th>
                <th>Calories/serv</th>
              </tr>
            </thead>
          </table>
        </div>
        <div class="table-body">
          <table class="table card-table mb-0" id="foods-body-table">
            <colgroup>
              <col>
              <col style="width: var(--col-ate)">
              <col style="width: var(--col-na)">
              <col style="width: var(--col-napct)">
              <col style="width: var(--col-k)">
              <col style="width: var(--col-pro)">
              <col style="width: var(--col-cal)">
            </colgroup>
            <tbody id="foods-body"></tbody>
          </table>
        </div>
      </div>

      <!-- RIGHT: Today -->
      <div class="totals-card">
        <div class="card-header">
          <h3 class="card-title mb-0">Today</h3>
          <div class="text-muted small">
            Enter your low / high range. Bars show:
            blue = below range, green = in range, red = above.
            Markers slide as you change the numbers.
          </div>
        </div>

        <div class="card-body" id="totals-panel"></div>

        <div class="card-body pt-0" id="all-totals-wrap">
          <button type="button" class="btn btn-success w-100 mb-2" id="btn-save-history">Save to History</button>
          <hr class="my-2">
          <div class="fw-semibold mb-2">All nutrients (live totals)</div>
          <table class="table table-sm mb-0">
            <tbody id="all-totals-body"></tbody>
          </table>
        </div>

        <div class="card-footer d-grid gap-2">
          <a class="btn btn-outline" href="{{ url_for('reports_day') }}">View day report</a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

<script>
  // ================= Constants & Setup =================
  const GOALS = { na: 1500, k: 3400, pro: 70, cal: 1500 };
  const SCALE = 1.25;  // bar extends to 125% of high threshold
  const $ = (s, r=document) => r.querySelector(s);

  let FOODS = [];
  let DATE_ISO = null;

  // Per-nutrient low/high ranges (defaults: 0–GOAL)
  let GOAL_RANGES = {
    na:  { low: 0,       high: GOALS.na },
    k:   { low: 0,       high: GOALS.k },
    pro: { low: 0,       high: GOALS.pro },
    cal: { low: 0,       high: GOALS.cal },
  };

  // Restore goal ranges from localStorage, if present
  function loadGoalRanges(){
    try {
      const raw = localStorage.getItem("diary-goal-ranges-v2");
      if (!raw) return;
      const data = JSON.parse(raw);
      if (!data || typeof data !== "object") return;

      ["na","k","pro","cal"].forEach(key => {
        if (data[key]) {
          const d = data[key];
          const base = GOAL_RANGES[key] || { low: 0, high: GOALS[key] || 0 };
          GOAL_RANGES[key] = {
            low:  typeof d.low  === "number" ? d.low  : base.low,
            high: typeof d.high === "number" ? d.high : base.high,
          };
        }
      });
    } catch (e) {
      console.warn("Failed to load goal ranges", e);
    }
  }

  function saveGoalRanges(){
    try {
      localStorage.setItem("diary-goal-ranges-v2", JSON.stringify(GOAL_RANGES));
    } catch (e) {
      console.warn("Failed to save goal ranges", e);
    }
  }

  function onGoalInputChange(e){
    const input = e.target;
    const key = input.dataset.key;
    const role = input.dataset.role;
    if (!key || !role) return;

    let val = Number(input.value);
    if (!Number.isFinite(val) || val < 0) val = 0;

    if (!GOAL_RANGES[key]) {
      GOAL_RANGES[key] = { low: 0, high: GOALS[key] || 0 };
    }

    if (role === "low") {
      GOAL_RANGES[key].low = val;
      if (GOAL_RANGES[key].low > GOAL_RANGES[key].high) {
        GOAL_RANGES[key].high = GOAL_RANGES[key].low;
        const hiInput = document.getElementById(`m-${key}-high`);
        if (hiInput) hiInput.value = GOAL_RANGES[key].high;
      }
    } else {
      GOAL_RANGES[key].high = val;
      if (GOAL_RANGES[key].high < GOAL_RANGES[key].low) {
        GOAL_RANGES[key].low = GOAL_RANGES[key].high;
        const loInput = document.getElementById(`m-${key}-low`);
        if (loInput) loInput.value = GOAL_RANGES[key].low;
      }
    }

    saveGoalRanges();
    updateTotals(); // re-color + re-position markers
  }

  // ================= Load Foods from Univer API =================
  async function loadFoodsFromUniver(){
    // Univer-backed table: /univer/api/foods-table -> { ok: true, rows: [headerRow, row1, ...] }
    const resp = await fetch('/univer/api/foods-table', { credentials: 'same-origin' });
    if (!resp.ok) throw new Error('Failed to load Univer foods-table: HTTP ' + resp.status);
    const js = await resp.json();
    if (!js.ok) throw new Error('Univer backend returned not-ok: ' + (js.error || 'unknown'));

    const rows = Array.isArray(js.rows) ? js.rows : [];
    if (!rows.length) {
      FOODS = [];
      return;
    }

    const header = (rows[0] || []).map(v => String(v ?? '').trim());
    const dataRows = rows.slice(1);

    function idxOf(name) {
      const target = name.toLowerCase();
      return header.findIndex(h => h.toLowerCase() === target);
    }

    const idxFood        = idxOf("Food");
    const idxServingSize = idxOf("Serving Size");
    const idxServingUnit = idxOf("Serving Unit");
    const idxLabelUnits  = idxOf("Label Units");
    const idxUnitType    = idxOf("Unit Type");

    const idxCalories    = idxOf("Calories");
    const idxProtein     = idxOf("Protein (g)");
    const idxCarbs       = idxOf("Carbs (g)");
    const idxFat         = idxOf("Fat (g)");
    const idxSat         = idxOf("Sat Fat (g)");
    const idxMono        = idxOf("Mono Fat (g)");
    const idxPoly        = idxOf("Poly Fat (g)");
    const idxSugar       = idxOf("Sugar (g)");
    const idxSodium      = idxOf("Sodium (mg)");
    const idxPotassium   = idxOf("Potassium (mg)");
    const idxCalcium     = idxOf("Calcium (mg)");
    const idxMagnesium   = idxOf("Magnesium (mg)");
    const idxIron        = idxOf("Iron (mg)");
    const idxChol        = idxOf("Cholesterol (mg)");

    if (idxFood < 0 || idxSodium < 0 || idxPotassium < 0 || idxProtein < 0 || idxCalories < 0) {
      throw new Error("Required columns not found in Univer header row");
    }

    const numAt = (row, idx) =>
      (idx >= 0 && row[idx] != null && row[idx] !== "") ? (Number(row[idx]) || 0) : 0;

    const out = [];
    for (const row of dataRows) {
      if (!row) continue;
      const name = row[idxFood];
      if (!name || !String(name).trim()) continue;

      out.push({
        food:        String(name).trim(),
        servingSize: numAt(row, idxServingSize),
        servingUnit: idxServingUnit >= 0 ? (row[idxServingUnit] || "").toString() : "",
        unitType:    idxUnitType    >= 0 ? (row[idxUnitType]    || "").toString() : "",
        labelUnits:  numAt(row, idxLabelUnits) || 1,

        cal:   numAt(row, idxCalories),
        pro:   numAt(row, idxProtein),
        carbs: numAt(row, idxCarbs),
        fat:   numAt(row, idxFat),
        sat:   numAt(row, idxSat),
        mono:  numAt(row, idxMono),
        poly:  numAt(row, idxPoly),
        sugar: numAt(row, idxSugar),

        na:    numAt(row, idxSodium),
        k:     numAt(row, idxPotassium),
        ca:    numAt(row, idxCalcium),
        mg:    numAt(row, idxMagnesium),
        iron:  numAt(row, idxIron),
        chol:  numAt(row, idxChol),
      });
    }

    FOODS = out;
  }

  // ================= Layout & styling helpers =================
  function sodiumBarCell(percent){
    const pct = Math.max(0, Math.min(percent, 100 * SCALE));
    return `
      <div class="sodbar" aria-label="Sodium percent of 1500">
        <div class="sodbar-fill" style="width:${pct}%;"></div>
      </div>
    `;
  }

  // ================= Render Foods Table =================
  function renderFoods(){
    const tbody = $("#foods-body");
    tbody.innerHTML = "";

    for (const f of FOODS){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td title="${f.food}">${f.food}</td>
        <td>
          <div class="ate-wrap">
            <input class="form-control form-control-sm amount" type="number" step="0.25" min="0" value="0">
            <select class="form-select form-select-sm unit-select">
              <option value="units" selected># Units</option>
              <option value="g">Grams</option>
              <option value="oz">Ounces</option>
            </select>
          </div>
        </td>
        <!-- Start these displayed values at 0; we keep per-serving in data-* -->
        <td class="text-end na">0</td>
        <td class="sodbar-cell">${sodiumBarCell(0)}</td>
        <td class="text-end k">0</td>
        <td class="text-end pro">0</td>
        <td class="text-end cal">0</td>
      `;

      // store per-serving values in dataset
      tr.dataset.food  = f.food ?? "";

      tr.dataset.na    = f.na    ?? 0;
      tr.dataset.k     = f.k     ?? 0;
      tr.dataset.pro   = f.pro   ?? 0;
      tr.dataset.cal   = f.cal   ?? 0;
      tr.dataset.chol  = f.chol  ?? 0;

      tr.dataset.carbs = f.carbs ?? 0;
      tr.dataset.fat   = f.fat   ?? 0;
      tr.dataset.sat   = f.sat   ?? 0;
      tr.dataset.mono  = f.mono  ?? 0;
      tr.dataset.poly  = f.poly  ?? 0;
      tr.dataset.sugar = f.sugar ?? 0;
      tr.dataset.ca    = f.ca    ?? 0;
      tr.dataset.mg    = f.mg    ?? 0;
      tr.dataset.iron  = f.iron  ?? 0;

      tr.dataset.labelUnits = f.labelUnits ?? 1;

      const input = tr.querySelector("input.amount");
      input.addEventListener("change", onAmountChange);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") e.currentTarget.blur();
      });

      const unitSel = tr.querySelector(".unit-select");
      unitSel.addEventListener("change", () => {
        tr.dataset.unit = unitSel.value;
        updateRowSodiumBar(tr);
        updateRowNutrientCells(tr);
        updateTotals();
        scheduleAutosaveFullDay();
      });

      tbody.appendChild(tr);
    }
  }

  // -------- Helper: effective servings for this row ------------------
  function effectiveServings(tr){
    const amt = Number(tr.querySelector("input.amount").value) || 0;
    const unit = tr.dataset.unit || (tr.querySelector(".unit-select")?.value || "units");
    const labelUnits = Number(tr.dataset.labelUnits || 0) || 1;

    if (unit === "units") {
      // amt = number of bars/slices; labelUnits = bars per label serving
      return amt / labelUnits;
    }
    // For now, grams/oz behave like "servings" (same as before).
    return amt;
  }

  // ================= Totals Panel =================
  function ensureTotalsPanel(){
    const host = $("#totals-panel");
    if (!host) return;
    host.innerHTML = "";
    makeMeter(host, "Sodium", "na", "mg", GOALS.na);
    makeMeter(host, "Potassium", "k", "mg", GOALS.k);
    makeMeter(host, "Protein", "pro", "g", GOALS.pro);
    makeMeter(host, "Calories", "cal", "", GOALS.cal);
  }

  function makeMeter(host, label, key, unit, goal){
    const range = GOAL_RANGES[key] || { low: 0, high: goal };

    const wrap = document.createElement("div");
    wrap.className = "meter";
    wrap.innerHTML = `
      <div class="meter-label">
        <span>${label}</span>
        <span id="m-${key}-val">0 ${unit}</span>
      </div>
      <div class="meter-track" id="m-${key}-track">
        <div class="meter-fill-below" id="m-${key}-below"></div>
        <div class="meter-fill-in" id="m-${key}-in"></div>
        <div class="meter-fill-over" id="m-${key}-over"></div>
        <div class="meter-marker" id="m-${key}-lowmark" style="left:0%;"></div>
        <div class="meter-marker meter-marker-high" id="m-${key}-highmark" style="left:0%;"></div>
      </div>
      <div class="meter-inputs">
        <label>
          Low
          <input type="number"
                 id="m-${key}-low"
                 data-key="${key}"
                 data-role="low"
                 min="0"
                 step="10"
          >
          ${unit}
        </label>
        <label>
          High
          <input type="number"
                 id="m-${key}-high"
                 data-key="${key}"
                 data-role="high"
                 min="0"
                 step="10"
          >
          ${unit}
        </label>
      </div>
      <div class="text-muted meter-goaltext" id="m-${key}-goaltext"></div>
    `;
    host.appendChild(wrap);

    const lowInput  = wrap.querySelector(`#m-${key}-low`);
    const highInput = wrap.querySelector(`#m-${key}-high`);
    if (lowInput)  lowInput.value  = range.low ?? 0;
    if (highInput) highInput.value = range.high ?? goal;

    if (lowInput)  lowInput.addEventListener("change", onGoalInputChange);
    if (highInput) highInput.addEventListener("change", onGoalInputChange);

    const goalText = wrap.querySelector(`#m-${key}-goaltext`);
    if (goalText) {
      goalText.textContent = `Range: ${range.low.toLocaleString()}–${range.high.toLocaleString()} ${unit}`.trim();
    }
  }

  // ================= Update on Input =================
  function onAmountChange(e){
    const tr = e.target.closest("tr");
    if (!tr) return;
    updateRowSodiumBar(tr);
    updateRowNutrientCells(tr);
    updateTotals();
    scheduleAutosaveFullDay();
  }

  function updateRowSodiumBar(tr){
    const servings = effectiveServings(tr);
    const naPer = Number(tr.dataset.na) || 0;
    const naTotal = servings * naPer;
    const pct = (naTotal / (GOALS.na * SCALE)) * 100;
    const fill = tr.querySelector(".sodbar-fill");
    if (fill) fill.style.width = `${Math.max(0, Math.min(pct, 100))}%`;
  }

  // NEW: update Na/serv, K/serv, Protein, Calories cells with multiplied amounts
  function updateRowNutrientCells(tr){
    const servings = effectiveServings(tr);

    const naVal   = servings * (Number(tr.dataset.na)  || 0);
    const kVal    = servings * (Number(tr.dataset.k)   || 0);
    const proVal  = servings * (Number(tr.dataset.pro) || 0);
    const calVal  = servings * (Number(tr.dataset.cal) || 0);

    const naCell  = tr.querySelector("td.na");
    const kCell   = tr.querySelector("td.k");
    const proCell = tr.querySelector("td.pro");
    const calCell = tr.querySelector("td.cal");

    if (naCell)  naCell.textContent  = Math.round(naVal).toLocaleString();
    if (kCell)   kCell.textContent   = Math.round(kVal).toLocaleString();
    if (proCell) proCell.textContent = proVal.toFixed(1).replace(/\.0$/,"");
    if (calCell) calCell.textContent = Math.round(calVal).toLocaleString();
  }

  // ================= All math (meters + full list) =================
  function sumFromTable(){
    const total = {
      na:0, k:0, pro:0, cal:0, chol:0,
      carbs:0, fat:0, sat:0, mono:0, poly:0, sugar:0,
      ca:0, mg:0, iron:0
    };
    document.querySelectorAll("#foods-body tr").forEach(tr => {
      const servings = effectiveServings(tr);

      total.na   += servings * (Number(tr.dataset.na)   || 0);
      total.k    += servings * (Number(tr.dataset.k)    || 0);
      total.pro  += servings * (Number(tr.dataset.pro)  || 0);
      total.cal  += servings * (Number(tr.dataset.cal)  || 0);
      total.chol += servings * (Number(tr.dataset.chol) || 0);

      total.carbs+= servings * (Number(tr.dataset.carbs)|| 0);
      total.fat  += servings * (Number(tr.dataset.fat)  || 0);
      total.sat  += servings * (Number(tr.dataset.sat)  || 0);
      total.mono += servings * (Number(tr.dataset.mono) || 0);
      total.poly += servings * (Number(tr.dataset.poly) || 0);
      total.sugar+= servings * (Number(tr.dataset.sugar)|| 0);
      total.ca   += servings * (Number(tr.dataset.ca)   || 0);
      total.mg   += servings * (Number(tr.dataset.mg)   || 0);
      total.iron += servings * (Number(tr.dataset.iron) || 0);
    });
    return total;
  }

  function paintMeter(key, value, goal, unit){
    const range = GOAL_RANGES[key] || { low: 0, high: goal };
    let low  = Math.max(0, Number(range.low)  || 0);
    let high = Math.max(low, Number(range.high) || goal);

    const cap = (high > 0 ? high * SCALE : (goal * SCALE) || 1);
    const pct = Math.max(0, Math.min((value / cap) * 100, 100));

    const belowEl = document.querySelector(`#m-${key}-below`);
    const inEl    = document.querySelector(`#m-${key}-in`);
    const overEl  = document.querySelector(`#m-${key}-over`);
    const lowMark = document.querySelector(`#m-${key}-lowmark`);
    const highMark= document.querySelector(`#m-${key}-highmark`);
    const valEl   = document.querySelector(`#m-${key}-val`);
    const goalText= document.querySelector(`#m-${key}-goaltext`);
    const lowInput= document.querySelector(`#m-${key}-low`);
    const highInput = document.querySelector(`#m-${key}-high`);
    if (!belowEl || !inEl || !overEl || !valEl) return;

    // keep inputs & text in sync with current interpreted range
    if (lowInput)  lowInput.value  = low;
    if (highInput) highInput.value = high;

    const lowPct  = Math.max(0, Math.min((low  / cap) * 100, 100));
    const highPct = Math.max(lowPct, Math.min((high / cap) * 100, 100));

    const belowWidth = Math.min(pct, lowPct);                // 0 → low
    const inWidth    = Math.max(0, Math.min(pct, highPct) - lowPct);  // low → min(value, high)
    const overWidth  = Math.max(0, pct - highPct);           // high → value

    // Below-range segment
    belowEl.style.left  = "0%";
    belowEl.style.width = `${belowWidth}%`;

    // In-range segment
    inEl.style.left  = `${lowPct}%`;
    inEl.style.width = `${inWidth}%`;

    // Over-range segment
    overEl.style.left  = `${highPct}%`;
    overEl.style.width = `${overWidth}%`;

    // Markers
    if (lowMark)  lowMark.style.left  = `${lowPct}%`;
    if (highMark) highMark.style.left = `${highPct}%`;

    // Label
    const displayVal = unit
      ? `${Math.round(value).toLocaleString()} ${unit}`
      : `${Math.round(value).toLocaleString()}`;
    valEl.textContent = displayVal;

    if (goalText) {
      goalText.textContent = `Range: ${low.toLocaleString()}–${high.toLocaleString()} ${unit}`.trim();
    }
  }

  function renderAllTotals(){
    const t = totalsForHistory();
    const rows = [
      ["Sodium (mg)",      t.Sodium ?? 0],
      ["Potassium (mg)",   t.Potassium ?? 0],
      ["Protein (g)",      t.Protein ?? 0],
      ["Calories",         t.Calories ?? 0],
      ["Cholesterol (mg)", t.Cholesterol ?? 0],
      ["Carbs (g)",        t.Carbs ?? 0],
      ["Fat (g)",          t.Fat ?? 0],
      ["Sat Fat (g)",      t["Sat Fat"] ?? 0],
      ["Mono Fat (g)",     t["Mono Fat"] ?? 0],
      ["Poly Fat (g)",     t["Poly Fat"] ?? 0],
      ["Sugar (g)",        t.Sugar ?? 0],
      ["Calcium (mg)",     t.Calcium ?? 0],
      ["Magnesium (mg)",   t.Magnesium ?? 0],
      ["Iron (mg)",        t.Iron ?? 0]
    ];
    const tbody = document.getElementById("all-totals-body");
    if (!tbody) return;
    tbody.innerHTML = rows
      .map(([k,v]) => `<tr><td>${k}</td><td class="text-end">${Number(v||0).toLocaleString()}</td></tr>`)
      .join("");
  }

  function updateTotals(){
    const t = sumFromTable();
    paintMeter("na",  t.na,  GOALS.na,  "mg");
    paintMeter("k",   t.k,   GOALS.k,   "mg");
    paintMeter("pro", t.pro, GOALS.pro, "g");
    paintMeter("cal", t.cal, GOALS.cal, "");
    renderAllTotals();
  }

  // ================= Save payload helpers =================
  function totalsForHistory(){
    const t = sumFromTable();
    return {
      Sodium:       Math.round(t.na),
      Potassium:    Math.round(t.k),
      Protein:      +t.pro.toFixed(1),
      Calories:     Math.round(t.cal),
      Cholesterol:  Math.round(t.chol),

      Carbs:        +t.carbs.toFixed(1),
      Fat:          +t.fat.toFixed(1),
      "Sat Fat":    +t.sat.toFixed(1),
      "Mono Fat":   +t.mono.toFixed(1),
      "Poly Fat":   +t.poly.toFixed(1),
      Sugar:        +t.sugar.toFixed(1),
      Calcium:      Math.round(t.ca),
      Magnesium:    Math.round(t.mg),
      Iron:         +t.iron.toFixed(1)
    };
  }

  function collectEntries(){
    const rows = [];
    document.querySelectorAll("#foods-body tr").forEach(tr => {
      const amt = Number(tr.querySelector("input.amount").value) || 0;
      if (amt <= 0) return;
      const servings = effectiveServings(tr);
      const num = (k) => servings * (Number(tr.dataset[k] || 0));
      rows.push({
        food:           tr.dataset.food || "",
        amount:         amt,
        unit:           tr.dataset.unit || (tr.querySelector(".unit-select")?.value || "units"),
        sodium_mg:      num("na"),
        potassium_mg:   num("k"),
        protein_g:      num("pro"),
        calories_kcal:  Math.round(num("cal")),
        cholesterol_mg: num("chol"),
        fat_g:          num("fat"),
        carbs_g:        num("carbs"),
        sugar_g:        num("sugar"),
        calcium_mg:     num("ca"),
        magnesium_mg:   num("mg"),
        iron_mg:        num("iron"),
      });
    });
    return rows;
  }

  // ================= Live full-day load/save =================
  let autosaveTimer = null;

  async function loadFullDayForCurrentDate() {
    const picker = document.getElementById("day-picker");
    const date = (picker && picker.value) ? picker.value : DATE_ISO;
    if (!date) return;

    try {
      const url = window.__HISTORY_API__?.full_get;
      if (!url) {
        console.warn("No full_get URL wired.");
        clearDiaryInputs();
        return;
      }

      const resp = await fetch(`${url}?date=${encodeURIComponent(date)}`, {
        credentials: "same-origin",
      });

      if (resp.status === 404) {
        console.log("No saved full-day for", date, "-> clearing diary only.");
        clearDiaryInputs();
        return;
      }

      if (!resp.ok) {
        throw new Error("HTTP " + resp.status);
      }

      const js = await resp.json();
      if (!js.ok || !js.day) {
        throw new Error("Bad full-day JSON");
      }

      const entries = js.day.entries || [];
      applyEntriesToDiary(entries);
    } catch (err) {
      console.error("loadFullDayForCurrentDate error", err);
      clearDiaryInputs();
    }
  }

  function clearDiaryInputs() {
    document.querySelectorAll("#foods-body tr").forEach(tr => {
      const amt = tr.querySelector("input.amount");
      const unitSel = tr.querySelector(".unit-select");
      if (amt) amt.value = "0";
      if (unitSel) {
        unitSel.value = "units";
        tr.dataset.unit = "units";
      }
      updateRowSodiumBar(tr);
      updateRowNutrientCells(tr);
    });
    updateTotals();
  }

  function applyEntriesToDiary(entries) {
    clearDiaryInputs();

    const byFood = {};
    (entries || []).forEach(e => {
      if (!e.food) return;
      byFood[String(e.food).toLowerCase()] = e;
    });

    document.querySelectorAll("#foods-body tr").forEach(tr => {
      const name = (tr.dataset.food || "").toLowerCase();
      const e = byFood[name];
      if (!e) return;

      const amt = tr.querySelector("input.amount");
      const unitSel = tr.querySelector(".unit-select");

      if (amt) amt.value = (e.amount != null ? e.amount : 0);
      if (unitSel) {
        const unit = e.unit || "units";
        unitSel.value = unit;
        tr.dataset.unit = unit;
      }

      updateRowSodiumBar(tr);
      updateRowNutrientCells(tr);
    });

    updateTotals();
  }

  function scheduleAutosaveFullDay() {
    if (!window.__HISTORY_API__?.full_save) return;
    if (autosaveTimer) window.clearTimeout(autosaveTimer);
    autosaveTimer = window.setTimeout(autosaveFullDay, 800);
  }

  async function autosaveFullDay() {
    autosaveTimer = null;
    const date = (document.querySelector("#day-picker")?.value || "").trim();
    if (!date) return;

    const payload = {
      date,
      entries: collectEntries()
    };

    try {
      const res = await fetch(window.__HISTORY_API__.full_save, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify(payload)
      });
      const js = await res.json().catch(() => ({}));
      if (!res.ok || !js.ok) {
        console.warn("Autosave failed:", js.error || res.status);
      } else {
        console.debug("Autosaved full day for", date);
      }
    } catch (err) {
      console.error("Autosave error:", err);
    }
  }

  // ================= Live draft save/load (localStorage) =================
  function saveDraftForDate(date){
    if (!date) return;
    const rows = [];
    document.querySelectorAll("#foods-body tr").forEach(tr => {
      const amtInput = tr.querySelector("input.amount");
      const unitSel  = tr.querySelector(".unit-select");
      if (!amtInput || !unitSel) return;

      const food = tr.dataset.food || "";
      if (!food) return;

      const rawAmt = amtInput.value;
      const amount = rawAmt === "" ? "" : (Number(rawAmt) || 0);
      const unit   = tr.dataset.unit || unitSel.value || "units";

      rows.push({ food, amount, unit });
    });

    const key = "diary-draft-" + date;
    try {
      localStorage.setItem(key, JSON.stringify({ date, rows }));
    } catch (e) {
      console.warn("Draft save failed", e);
    }
  }

  function loadDraftForDate(date){
    if (!date) return;
    const key = "diary-draft-" + date;
    let raw = null;

    try {
      raw = localStorage.getItem(key);
    } catch (e) {
      console.warn("Draft load failed", e);
      return;
    }

    if (!raw) {
      document.querySelectorAll("#foods-body tr").forEach(tr => {
        const amtInput = tr.querySelector("input.amount");
        const unitSel  = tr.querySelector(".unit-select");
        if (amtInput) amtInput.value = "0";
        if (unitSel) {
          unitSel.value = "units";
          tr.dataset.unit = "units";
        }
        updateRowSodiumBar(tr);
        updateRowNutrientCells(tr);
      });
      updateTotals();
      return;
    }

    let data;
    try {
      data = JSON.parse(raw);
    } catch (e) {
      console.warn("Bad draft JSON", e);
      return;
    }

    const rowsByFood = {};
    (data.rows || []).forEach(r => {
      if (r.food) rowsByFood[r.food] = r;
    });

    document.querySelectorAll("#foods-body tr").forEach(tr => {
      const food = tr.dataset.food || "";
      const rec  = rowsByFood[food];

      const amtInput = tr.querySelector("input.amount");
      const unitSel  = tr.querySelector(".unit-select");
      if (!amtInput || !unitSel) return;

      if (rec) {
        amtInput.value = rec.amount === "" ? "" : (rec.amount ?? 0);
        unitSel.value  = rec.unit || "units";
        tr.dataset.unit = unitSel.value;
      } else {
        amtInput.value = "0";
        unitSel.value  = "units";
        tr.dataset.unit = "units";
      }

      updateRowSodiumBar(tr);
      updateRowNutrientCells(tr);
    });

    updateTotals();
  }

  // ================= Date controls =================
  function dateFromIso(iso) {
    const [y, m, d] = iso.split("-").map(Number);
    return new Date(y, m - 1, d);
  }

  function toIsoDate(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function initDate() {
    const picker = document.getElementById("day-picker");

    if (picker) {
      if (!picker.value) {
        const today = new Date();
        picker.value = toIsoDate(today);
      }
      DATE_ISO = picker.value;

      picker.addEventListener("change", () => {
        DATE_ISO = picker.value || DATE_ISO;
        loadFullDayForCurrentDate();
      });
    } else {
      const today = new Date();
      DATE_ISO = toIsoDate(today);
    }

    document.getElementById("btn-prev")?.addEventListener("click", () => shiftDate(-1));
    document.getElementById("btn-next")?.addEventListener("click", () => shiftDate(+1));
  }

  function shiftDate(delta) {
    const picker = document.getElementById("day-picker");
    const baseStr = (picker && picker.value) || DATE_ISO;

    const d = dateFromIso(baseStr || DATE_ISO);
    d.setDate(d.getDate() + delta);

    const newIso = toIsoDate(d);
    DATE_ISO = newIso;
    if (picker) picker.value = newIso;

    console.log("shiftDate", { delta, baseStr, newIso });

    if (typeof loadFullDayForCurrentDate === "function") {
      loadFullDayForCurrentDate();
    }
  }

  // ================= API wiring =================
  window.__HISTORY_API__ = Object.assign(window.__HISTORY_API__ || {}, {
    save:      "{{ url_for('history.api_day_save') }}",
    get:       "{{ url_for('history.api_day_get') }}",
    full_get:  "{{ url_for('history.api_full_day_get') }}",
    full_save: "{{ url_for('history.api_full_day_autosave') }}"
  });

  async function handleSaveToHistory(ev){
    ev?.preventDefault?.();
    const date = (document.querySelector("#day-picker")?.value || "").trim();
    if (!date) { alert("Pick a date first."); return; }

    try { updateTotals(); } catch(e) {}

    const payload = { date, totals: totalsForHistory(), entries: collectEntries() };
    console.log("Saving payload", payload);

    const btn = document.getElementById("btn-save-history");
    if (btn) { btn.disabled = true; btn.textContent = "Saving…"; }

    try{
      const res = await fetch(window.__HISTORY_API__.save, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        credentials: "same-origin",
        body: JSON.stringify(payload)
      });
      const js = await res.json().catch(()=> ({}));
      if (!res.ok || !js.ok) throw new Error(js.error || ("HTTP "+res.status));
      if (btn) {
        btn.classList.remove("btn-success");
        btn.classList.add("btn-secondary");
        btn.textContent = "Saved";
      }
      alert("Saved day " + date);
    }catch(e){
      console.error(e);
      alert("Save failed: " + e.message);
      if (btn) { btn.disabled = false; btn.textContent = "Save to History"; }
    }
  }

  // ================= Boot =================
  (async function boot(){
    try{
      await loadFoodsFromUniver();
      renderFoods();
      loadGoalRanges();
      ensureTotalsPanel();
      updateTotals();
    }catch(err){
      console.error(err);
      renderFoods();
      loadGoalRanges();
      ensureTotalsPanel();
      updateTotals();
    }
    initDate();
    await loadFullDayForCurrentDate();
    document.getElementById("btn-save-history")?.addEventListener("click", handleSaveToHistory);
  })();
</script>
{% endblock %}
