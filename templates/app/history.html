{# templates/app/history.html #}
{% extends "app_base.html" %}
{% block title %}Daily Records History — Nutrition Tracker{% endblock %}

{% block head_extra %}
<style>
  .history-wrap .table { font-size:.95rem; white-space:nowrap; }
  .history-wrap .table th, .history-wrap .table td { vertical-align:middle; }
  .history-wrap .micro { font-size:.825rem; color:var(--tblr-secondary,#6c757d); }
  .history-wrap .headbar {
    display:flex; gap:.5rem; align-items:center; justify-content:space-between; margin-bottom:.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="page-wrapper">
  <div class="container-xl">

    {# top header #}
    <div class="page-header d-print-none">
      <div class="row align-items-center">
        <div class="col">
          <h2 class="page-title">Daily Records History</h2>
          <div class="text-muted mt-1">Log of saved daily totals.</div>
        </div>
      </div>
    </div>

    {% if not days or days|length == 0 %}
      <div class="alert alert-info">
        No saved days yet. Go to <a href="{{ url_for('app_daily') }}">Daily</a>, then click
        <em>Save to History</em> to snapshot totals.
      </div>
    {% else %}

      <!-- === HEADBAR + TABLE === -->
      <div class="history-wrap">
        <div class="headbar">
          <div class="micro">
            User: <strong>{{ uid }}</strong>
            &nbsp;·&nbsp; File: <code>{{ file_path }}</code>
            &nbsp;·&nbsp; {{ days|length }} day{{ '' if days|length == 1 else 's' }}
          </div>
          <div class="d-flex gap-2">
            <a class="btn btn-outline btn-sm" href="{{ url_for('history.api_history_csv') }}">Download CSV</a>
          </div>
        </div>

        <div class="card">
          <div class="table-responsive">
            <table class="table table-sm table-striped card-table mb-0">
              <thead class="table-light position-sticky top-0">
                <tr>
                  <th>Date</th>
                  <th class="text-end">Sodium (mg)</th>
                  <th class="text-end">Potassium (mg)</th>
                  <th class="text-end">Cholesterol (mg)</th>
                  <th class="text-end">Protein (g)</th>
                  <th class="text-end">Calories</th>
                  <th class="text-end">Carbs (g)</th>
                  <th class="text-end">Fat (g)</th>
                  <th class="text-end">Sat Fat (g)</th>
                  <th class="text-end">Mono Fat (g)</th>
                  <th class="text-end">Poly Fat (g)</th>
                  <th class="text-end">Sugar (g)</th>
                  <th class="text-end">Calcium (mg)</th>
                  <th class="text-end">Magnesium (mg)</th>
                  <th class="text-end">Iron (mg)</th>
                </tr>
              </thead>
              <tbody>
                {% for d in days %}
                  {% set t = d.totals or {} %}
                  <tr>
                    <td><strong>{{ d.date }}</strong></td>
                    <td class="text-end">{{ "{:,}".format((t.get('Sodium',0)   or 0)|int) }}</td>
                    <td class="text-end">{{ "{:,}".format((t.get('Potassium',0) or 0)|int) }}</td>
                    <td class="text-end">{{ "{:,}".format((t.get('Cholesterol',0) or 0)|int) }}</td>
                    <td class="text-end">{{ "%.1f"|format(t.get('Protein',0)    or 0) }}</td>
                    <td class="text-end">{{ "{:,}".format((t.get('Calories',0)  or 0)|int) }}</td>
                    <td class="text-end">{{ "%.1f"|format(t.get('Carbs',0)      or 0) }}</td>
                    <td class="text-end">{{ "%.1f"|format(t.get('Fat',0)        or 0) }}</td>
                    <td class="text-end">{{ "%.2f"|format(t.get('Sat Fat',0)    or 0) }}</td>
                    <td class="text-end">{{ "%.2f"|format(t.get('Mono Fat',0)   or 0) }}</td>
                    <td class="text-end">{{ "%.2f"|format(t.get('Poly Fat',0)   or 0) }}</td>
                    <td class="text-end">{{ "%.1f"|format(t.get('Sugar',0)      or 0) }}</td>
                    <td class="text-end">{{ "{:,}".format((t.get('Calcium',0)   or 0)|int) }}</td>
                    <td class="text-end">{{ "{:,}".format((t.get('Magnesium',0) or 0)|int) }}</td>
                    <td class="text-end">{{ "%.1f"|format(t.get('Iron',0)       or 0) }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

    {% endif %}

  </div>
</div>
{% endblock %}
