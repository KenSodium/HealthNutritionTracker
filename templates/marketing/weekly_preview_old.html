{# templates/weekly_preview.html #}
{% extends "app_base.html" %}

{% block title %}CKD Weekly Summary (Preview){% endblock %}

{% block content %}
<div style="background: yellow; padding: 4px; font-weight: bold;">
  DEBUG: weekly_preview template
</div>
<div class="page-body">
<div class="page-body">
  <div class="container-xl py-4">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h1 class="h2 mb-1">CKD Weekly Summary (Preview)</h1>
        <div class="text-muted">
          Patient: <strong>{{ patient_name }}</strong><br>
          Period: <strong>{{ meta.from }}</strong> – <strong>{{ meta.to }}</strong><br>
          Data for {{ meta.days_with_data }} of {{ meta.window_days }} days in this window.
        </div>
        {% if meta.days_with_data > 0 and meta.missing_days > 0 %}
          <div class="text-warning mt-1" style="font-size:0.9rem;">
            Some days are missing; averages are based only on days with logged data.
          </div>
        {% endif %}
      </div>
      <div class="d-flex gap-2">
        <a href="{{ url_for('home') }}" class="btn btn-outline-secondary">Home</a>
        <button class="btn btn-primary" onclick="window.print()">Print / Save as PDF</button>
      </div>
    </div>

    {% if meta.days_with_data == 0 %}
      <div class="alert alert-info">
        No data found for the last 7 days. Log a few days in the
        <a href="{{ url_for('app_daily') }}" class="alert-link">Daily Diary</a>, then return here.
      </div>
    {% else %}

      <!-- Key nutrients -->
      <div class="card mb-3">
        <div class="card-body">
          <h2 class="h4 mb-3">
            Key Nutrients (7-day averages &amp; ranges)
          </h2>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>Nutrient</th>
                  <th>Target*</th>
                  <th class="text-end">Average</th>
                  <th class="text-end">Range (Min–Max)</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for r in featured_rows %}
                  <tr>
                    <td>{{ r.name }} ({{ r.unit }})</td>
                    <td>{{ r.target }}</td>
                    <td class="text-end">{{ r.avg_display }}</td>
                    <td class="text-end">{{ r.range }}</td>
                    <td><span class="{{ r.status_cls }}">{{ r.status_text }}</span></td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <p class="mt-2 mb-0 text-muted" style="font-size:0.85rem;">
            * Targets for sodium and potassium come from your Daily Diary settings
            (based on limits consistent with American Heart Association guidance).
            Other ranges are illustrative and may be adjusted by your clinician.
          </p>
        </div>
      </div>

      <!-- Additional nutrients -->
      <div class="card mb-3">
        <div class="card-body">
          <h2 class="h5 mb-3">Additional Nutrients (7-day summary)</h2>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>Nutrient</th>
                  <th class="text-end">Average</th>
                  <th class="text-end">Min</th>
                  <th class="text-end">Max</th>
                </tr>
              </thead>
              <tbody>
                {% for r in supplemental_rows %}
                  <tr>
                    <td>{{ r.name }} ({{ r.unit }})</td>
                    <td class="text-end">{{ r.avg_display }}</td>
                    <td class="text-end">{{ r.min_display }}</td>
                    <td class="text-end">{{ r.max_display }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {% if notes %}
        <div class="card">
          <div class="card-body">
            <h2 class="h5 mb-2">Auto-generated Notes</h2>
            <ul class="mb-0">
              {% for n in notes %}
                <li>{{ n }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      {% endif %}
    {% endif %}
  </div>
</div>
{% endblock %}
